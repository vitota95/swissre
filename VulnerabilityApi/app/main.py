from typing import List, Optional

from fastapi import FastAPI, HTTPException, Query

from app.adapters.in_memory_repository import InMemoryVulnerabilityRepository
from app.application.vulnerability_service import VulnerabilityService
from app.models.models import Vulnerability

app = FastAPI()

repository = InMemoryVulnerabilityRepository()
service = VulnerabilityService(repository)


@app.post("/vulnerability", response_model=Vulnerability)
def create_vulnerability(vulnerability: Vulnerability):
    try:
        return service.create_vulnerability(vulnerability)
    except ValueError as e:
        raise HTTPException(status_code=500, detail=str(e.args))


@app.get("/vulnerability/{cve}", response_model=Vulnerability)
def get_vulnerability(cve: str):
    try:
        return service.get_vulnerability(cve)
    except ValueError as e:
        raise HTTPException(status_code=404, detail=str(e))


@app.get("/vulnerability", response_model=List[Vulnerability])
def get_vulnerabilities(
    title: Optional[str] = None,
    min_criticality: Optional[int] = Query(None, ge=0, le=10),
    max_criticality: Optional[int] = Query(None, ge=0, le=10),
):
    try:
        return service.get_vulnerabilities(title, min_criticality, max_criticality)
    except ValueError as e:
        raise HTTPException(status_code=404, detail=str(e))


@app.delete("/vulnerability/{cve}", response_model=Vulnerability)
def delete_vulnerability(cve: str):
    try:
        return service.delete_vulnerability(cve)
    except ValueError as e:
        raise HTTPException(status_code=404, detail=str(e))
